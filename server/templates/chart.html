<script>
	function draw(canvasName) {

        // Get Canvas and Create Chart
        var canvas = document.getElementById(canvasName);


        seq = "{{geneSeq}}";
        cdsName = "{{cdsName}}"

        // Create Chart
        chart1 = new Scribl(canvas, 705);
        chart1.glyph.color = "black";
        chart1.glyph.text.size = 10;
        chart1.glyph.text.font = "courier";
        chart1.glyph.text.align = "left";
   		chart1.glyph.roundness = 10;
        chart1.laneSizes = parseInt(20);
		chart1.laneBuffer = 15;
		chart1.scale.font.size = 12;
		chart1.tick.major.size = Math.ceil(seq.length / 1000) * 500;
		chart1.tick.minor.size = Math.ceil(seq.length / 1000) * 100;
		chart1.scale.max = Math.ceil(seq.length/chart1.tick.major.size) * chart1.tick.major.size;
		chart1.scale.min = 50;
		chart1.tick.auto = false;
		chart1.scale.size = 12;
		chart1.scale.font.size = 12;
		chart1.scale.font.color = "black";
		chart1.scale.font.size = 12;
		
        // Add Promoters:
        promoterTrack = chart1.addTrack();
		
		promoterLeft = promoterTrack.addFeature(
			new Complex('promoter', 0, {{gene[0]}}, '+' , [
				new BlockArrow('arrowLeft', 0, {{gene[0]}}, '+', {'borderColor':'black'})
				])
		);

		promoterLeft.onMouseover = function(){
			redraw(promoterLeft);
			var me = chart1.myMouseEventHandler;
			var Copy = promoterLeft;
			Copy.onMouseover = "Forward Promoter";
			me.tooltip.fire(Copy);
		};
		promoterLeft.onClick = function(){highlight_seq( promoterLeft, "yellow");
		};

		promoterLeft.setColorGradient('rgb(255, 255, 0)','rgb(205, 205, 0)');

		promoterTrack2 = chart1.addTrack();
		console.log("geneLength: "+{{geneSeq|length}});
		console.log("geneStart: "+{{gene[0]}});
		console.log("geneEnd: "+{{gene[1]}});
		console.log("geneLength - End: "+{{geneSeq|length - gene[1]}});
		
		promoterRight = promoterTrack2.addFeature(
			new Complex('promoter', {{gene[1]}}, {{geneSeq|length - gene[1]}}, '-' , [
				new BlockArrow('arrowRight', 0, {{geneSeq|length - gene[1]}}, '+', {'borderColor':'black'})
			])
		);

		
		promoterRight.onMouseover = function(){
			redraw(promoterRight);
			var me = chart1.myMouseEventHandler;
			var Copy = promoterRight;
			Copy.onMouseover = "Backward Promoter";
			me.tooltip.fire(Copy);
		};
		promoterRight.onClick = function(){highlight_seq( promoterRight, "yellow");
		};

		promoterRight.setColorGradient('rgb(255, 255, 0)','rgb(205, 205, 0)');

		//Add Genes:

		geneTrack = chart1.addTrack();
        
        gene = geneTrack.addFeature(
        	new Complex('gene', {{ gene[0] }}, {{ gene[1] - gene[0] }}, '+', [
        		new Rect('gene', 0, {{ gene[1] - gene[0] }}, {'borderColor':'black'} )
        		])
        );

    	// Color for feature: (Top , Bottom), in rgb.
        gene.setColorGradient('rgb(0, 225, 0)','rgb(0, 155, 0)');
        // Mouseover description
        gene.onMouseover = function(){
        	redraw(gene);
			var me = chart1.myMouseEventHandler;
			var Copy = gene;
			Copy.onMouseover = "{{geneName}}";
			me.tooltip.fire(Copy);
        };

        gene.onClick = function(){
        	highlight_seq(gene, "green")
        };

         // add name
        gene.subFeatures[0].name = "{{geneName}}";
        gene.text.color = "black";

        //Add mRNA:
		
		mrnaTrack = chart1.addTrack();

		// Construct mRNAs
		mrnaList = [];
	   	{% for mrnaName, mrna in mrnas.iteritems() %}
			// Define starting point of mrna in gene
	  		var start = {{ mrna[0][0] }};
	  		
	  		// Add objects to mrnaList
	        mrnaList[{{ loop.index -1 }}] = mrnaTrack.addFeature(
	        	new Complex('mrna', {{ mrna[0][0] }}, {{ mrna[-1][1] - mrna[0][0] }} , '+', [
					// add exons   type, relative-start, length ...
			        {% for exon in mrna  %}
			        	new Rect('mrna',{{ exon[0] }} - start, {{ exon[1] - exon[0] }}, {'borderColor':'black'}),
					{% endfor %}
				]) 
	        );

	    	// Define name and behaviours for each element
		   	mrnaList[{{ loop.index -1 }}].setColorGradient('rgb(255, 0, 0)','rgb(185, 0, 0)');
	        mrnaList[{{ loop.index -1 }}].onMouseover = function(){
	        	redraw( mrnaList[{{ loop.index -1 }}]);
				var me = chart1.myMouseEventHandler;
				var Copy = mrnaList[{{ loop.index -1 }}];
				Copy.onMouseover = "{{mrnaName}}";
				me.tooltip.fire(Copy);
	     	};

	        mrnaList[{{ loop.index -1 }}].onClick = function(){
	        	highlight_seq( mrnaList[{{ loop.index -1 }}], "red");
	        };

			mrnaList[{{ loop.index -1 }}].subFeatures[0].name = "{{mrnaName}}";
	        mrnaList[{{ loop.index -1 }}].text.color = "black";
	   	{% endfor %}

	    cdsList = [];
		{% for _cdsName, cds in cdss.iteritems() %}
			// Create mrna name list
			// Define starting point of cds in gene
      		var start = {{ cds[0][0] }};
      		var stop =  {{ cds[-1][1] }};
		 	
		 	// DIFFERENT LANES?
		 	cdsTrack{{loop.index -1}} = chart1.addTrack().addLane();

		 	cdsList[{{ loop.index -1 }}] = cdsTrack{{loop.index -1}}.addFeature(
	        	new Complex('cds', {{ cds[0][0] }}, {{ cds[-1][1] - cds[0][0] }} , '{{cds[0][2]}}', [
		    		// add exons   type, relative-start, length ...
		        	{% for exon in cds  %}
			        	{% if exon[2] == '-'  %}
			        		new BlockArrow('cds',stop - {{ exon[1] }}, {{ exon[1] - exon[0] }}, '{{exon[2]}}', {'borderColor':'black'}),
			        	{% else %}
			        		new BlockArrow('cds',{{ exon[0] }}-start, {{ exon[1] - exon[0] }}, '{{exon[2]}}', {'borderColor':'black'}),
			        	{% endif %}
					{% endfor %}
					])
			);
			
		 	cdsList[{{ loop.index -1 }}].setColorGradient('rgb(0, 150, 255)','rgb(0, 110, 215)');

			{% if cdsName == _cdsName %}
	        	cdsList[{{ loop.index -1 }}].borderWidth = 5;  	
	        {% endif %}


			// Defining function for hover on feature 
	        cdsList[{{ loop.index -1 }}].onMouseover = function(){
	        	redraw(cdsList[{{ loop.index -1 }}]);
				var me = chart1.myMouseEventHandler;
				var Copy = cdsList[{{ loop.index -1 }}];
				Copy.onMouseover = "{{_cdsName}}";
				me.tooltip.fire(Copy);
	        };
	        
			
			cdsList[{{ loop.index -1 }}].onClick = function() {
				{% if cdsName == _cdsName %}
					highlight_seq(cdsList[{{ loop.index -1 }}], "blue");
				{% else %}
					window.location = '/details?name={{_cdsName}}';
				{%endif%}
			};

			cdsList[{{ loop.index -1 }}].subFeatures[0].name = "{{_cdsName}}";
	        cdsList[{{ loop.index -1 }}].text.color = "black";
	   		
	   	{% endfor %}        
    
		canvas.height = chart1.getHeight() + 20;
        chart1.draw();

        // Create image of chart1
       // var img = chart1.canvas.toDataURL("image/png");
        // Add link to download image
       // $("a#export").attr('href', img);

          chart1.glyph.color = undefined;
    }

    function redraw(element) {
    	canvas = chart1.canvas;
		// Defining color feature hovered on
	   	// element.setColorGradient('rgb(0, 75, 128)','rgb(0, 55, 107)');
	   	element.borderWidth = 5;
		//element[number].text.color = "white";
		canvas.height = chart1.getHeight() + 20;
		chart1.redraw();   
		// Create image of chart1
		//var img = chart1.canvas.toDataURL("image/png");
		// Add link to download image
		//$("a#export").attr('href', img);
		chart1.glyph.color = undefined;
	}
		 
	function draworig() {
		canvas = chart1.canvas;
		canvas.height = chart1.getHeight() + 20;
		// Defining color feature hovered on

		// promoterLeft.setColorGradient('rgb(255, 255, 0)','rgb(205, 205, 0)');
		promoterLeft.borderWidth = 2;
		// promoterRight.setColorGradient('rgb(255, 255, 0)','rgb(205, 205, 0)');
		promoterRight.borderWidth = 2;
		
		// gene.setColorGradient('rgb(0, 225, 0)','rgb(0, 155, 0)');
		gene.text.color = "black";
		gene.borderWidth = 2;
		
		for(i=0; i < mrnaList.length; i++){
			// mrnaList[i].setColorGradient('rgb(255, 0, 0)','rgb(185, 0, 0)');
			mrnaList[i].borderWidth = 2;
			mrnaList[i].text.color = "black";
		}

		for(i=0; i < cdsList.length; i++){

			if (cdsName == cdsList[i].subFeatures[0].name){
				cdsList[i].borderWidth = 5;
				// cdsList[i].setColorGradient('rgb(0, 75, 128)','rgb(0, 55, 107)');
			}

			else{
				cdsList[i].borderWidth = 2;
				// cdsList[i].setColorGradient('rgb(0, 150, 255)','rgb(0, 110, 215)');
			}

		 	cdsList[i].text.color = "black";    
		}
	
		chart1.redraw(); 
		// Create image of chart1
		//var img = chart1.canvas.toDataURL("image/png");
		// Add link to download image
		//$("a#export").attr('href', img);
		chart1.glyph.color = undefined;
	}

</script>